var xhr = null;
$(function() {
	/*首页*/
    $(document).on("pageInit", "#page-index", function(e, pageId, page) {
    	//团免券
    	if($(".popup-coupon").length>0 && !localStorage.freeCoupon){
    		$.popup('.popup-coupon');
    		localStorage.freeCoupon = true;
    	}
    	
    	//生成左右滑动页面
    	$(".index-page>.swiper-wrapper").html('');
    	$(".index-class .swiper-wrapper>a").each(function(index, el) {
    		var type = $(el).attr("data-type");
    		var html = '<div class="swiper-slide" id="index_page_'+ (index+1) +'">';
    		switch (type){
    			case 'index':
    				html += '<section class="swiper-container index-banner" data-space-between="0">'
			             +      '<div class="swiper-wrapper"></div>'
			             +      '<div class="swiper-pagination"></div>'
			             +  '</section>'
    				     +  '<section class="index-index infinite-scroll infinite-scroll-bottom" data-distance="30">'
                         +      '<h2 class="index-pro-title"></h2>'
                         +      '<ul class="list-container"></ul>'
                         +      '<div class="infinite-scroll-preloader">'
                         +          '<div class="preloader"></div>'
                         +      '</div>'
                         +  '</section></div>';
                    break;
    			case 'class':
    				html += '<section class="index-pro infinite-scroll infinite-scroll-bottom" data-distance="30">'
                         +      '<ul class="list-container"></ul>'
                         +      '<div class="infinite-scroll-preloader">'
                         +          '<div class="preloader"></div>'
                         +      '</div>'
                         +  '</section></div>';
                    break;
    		}
    		$(".index-page>.swiper-wrapper").append(html);
    	});
	    //页面左右滑动
	    var swiperIndexPage = new Swiper('.index-page', {
	        spaceBetween: 0,
	        onSlideChangeStart:function(){
	        	$(".index-page").find('.infinite-scroll-preloader').show();
	        	$(".index-page").find('.infinite-scroll-bottom .list-container').html('');
	        },
	        onSlideChangeEnd: function(e){
	        	var index = swiperIndexPage.activeIndex + 1;
	        	swiperIndexClass.slideTo(index-1, 400, true);
	        	$(".index-class .swiper-wrapper>a").removeClass("active").eq(index-1).addClass("active");
	        	//容器发生改变,如果是js滚动，需要刷新滚动
            	$(".index-page").scroller('refresh');

            	var pageObj = $(".index-class .swiper-wrapper>a").eq(index-1);
            	var type = pageObj.attr("data-type"),
            		url = pageObj.attr("data-href");
            	
            	loading = false,
	        	pageCount = 2,
	        	pageNow = 1;
            	getData(index, type, url);
	        }
	    });
    	//分类导航滑动
    	var swiperIndexClass = new Swiper('.index-class', {
	        spaceBetween: 0,
    		freeMode : true,
			slidesPerView : 'auto',
			onSlideChangeEnd: function(){
				var index = swiperIndexPage.activeIndex;
				swiperIndexPage.slideTo(index, 400, true);
			}
	    });
	    //点击分类导航页面左右滑动
	    $(".index-class .swiper-wrapper>a").on("click", function(){
	    	var index = $(".index-class .swiper-wrapper>a").index(this);
	    	swiperIndexPage.slideTo(index, 400, true);
	    });


        var loading = false,
        	pageCount = 2,
        	pageNow = 1;

        //预先加载
        getData(1, 'index', $(".index-class .swiper-slide").eq(0).attr("data-href"));

        // 注册'infinite'事件处理函数
        $(page).on('infinite', function() {
        	var pageIndex = $(".index-class a").index($(".index-class a.active"))+1,
        		type = $(".index-class .swiper-wrapper>a.active").attr("data-type"),
        		url = $(".index-class .swiper-wrapper>a.active").attr("data-href");

            // 如果正在加载，则退出
            if (loading) return;

            // 设置flag
            loading = true;

            getData(pageIndex, type, url);

            //容器发生改变,如果是js滚动，需要刷新滚动
            $.refreshScroller();
        });

        function getData(index_page, type, url){
        	$.ajax({
            	url: url,
            	type: 'POST',
            	dataType: 'json',
            	data: {
            		page: pageNow
            	},
            	success: function(res){
		            switch (type){
		            	case "index" :
		            		var html = '';
		            		var bannerData = res["data"]["image"];
		            		for(var i=0; i<bannerData.length; i++){
		            			html += '<a class="swiper-slide" href="'+ bannerData[i]["url"] +'"><img src="http://ext1.taozhuma.com/upfiles/focusbanner/'+ bannerData[i]["banner"] +'"></a>'
		            		}
				    		swiperIndexBanner = new Swiper('.index-banner', {
						        spaceBetween: 0,
						        pagination: '.swiper-pagination',
						        observer: true
						    });
		            		$(".index-banner .swiper-wrapper").html(html);
		            		html = '';
		            		var proData = res["data"]["groupon"];
		            		if(!!proData["DataSet"]){
			            		for(var i=0; i<proData["DataSet"].length; i++){
			            			html += '<li><a href="groupon.php?id='+ proData["DataSet"][i]["gid"] +'">'
							             +      '<div class="img"><img src="http://ext1.taozhuma.com/upfiles/product/'+ proData["DataSet"][i]["image_main"] +'" /></div>'
							             +      '<div class="info">'
							             +          '<p class="name">'+ proData["DataSet"][i]["product_name"] +'</p>'
							             +          '<span class="sales">销量：'+ proData["DataSet"][i]["sell_number"] +'</span>'
							             +      '</div>'
							             +      '<div class="group">'
							             +          '<span class="num">'+ proData["DataSet"][i]["num"] +'人团</span>'
							             +          '￥<span class="now-price">'+ proData["DataSet"][i]["selling_price"] +'</span>'
							             +          '<span class="old-price">￥'+ proData["DataSet"][i]["price"] +'</span>'
							             +      '</div>'
							             +  '</a></li>'
			            		}
		            		}else{
		            			html = '<div class="tips-null">暂无商品</div>';
		            		}
		            		$("#index_page_" + index_page).find('.infinite-scroll-bottom .list-container').append(html);

				            // 重置加载flag
				            loading = false;
				            pageCount = proData["PageCount"],
		        			pageNow = proData["CurrentPage"] + 1;
		            		break;
		            	case 'class':
		            		var html = '';
		            		var proData = res["data"]["product"];
		            		var countData = res["data"]["count"];
		            		if(!!proData["DataSet"]){
		            			for(var i=0; i<proData["DataSet"].length; i++){

			            			if(countData[i][0]["count( * )"] > 1){
			            				html += '<li><a href="groupon_multi.php?id='+ countData[i][0]["product_id"] +'">';
			            			}else{
			            				html += '<li><a href="groupon.php?id='+ proData["DataSet"][i]["gid"] +'">';
			            			}
				            			
				                   html +=       '<div class="img"><img src="'+ proData["DataSet"][i]["image_small"] +'" /></div>'
				                         +       '<div class="name">'
				                         +           '<span class="num">'+ proData["DataSet"][i]["num"] +'人团</span>'+ proData["DataSet"][i]["product_name"]
				                         +       '</div>'
				                         +       '<div class="info">'
				                         +           '￥<span class="price">'+ proData["DataSet"][i]["selling_price"] +'</span>'
				                         +           '<span class="sales">已团'+ proData["DataSet"][i]["sell_number"] +'件</span>'
				                         +       '</div>'
				                         +   '</a></li>';
			                    }
		            		}else{
		            			html = '<div class="tips-null">暂无商品</div>';
		            		}
		            		
		            		$("#index_page_" + index_page).find('.infinite-scroll-bottom .list-container').append(html);

				            // 重置加载flag
				            loading = false;
				            pageCount = proData["PageCount"],
		        			pageNow = proData["CurrentPage"] + 1;
		            		break;
		            }

		            if (pageNow >= pageCount) {
		            	loading = true;
		            	$(".index-page>.swiper-wrapper>.swiper-slide-active .infinite-scroll-preloader").hide();
		            }

            	}
            });
        }

    });


	/*详情页*/
    $(document).on("pageInit", "#page-deta", function(e, pageId, page) {
    	//产品banner
    	swiperDetaBanner = new Swiper('.deta-banner', {
	        spaceBetween: 0,
	        pagination: '.swiper-pagination',
	        observer: true
	    });

	    //倒计时
	    $(".deta-group .list li").each(function(index, el) {
	    	var time = parseInt($(el).find(".timer").attr("data-timer"));
	    	$(el).find(".timer span").html(timeToDate(time));
	    	var downTimer = setInterval(function(){
	    		--time;
	    		$(el).find(".timer span").html(timeToDate(time));
	    		if(time<=0){
	    			$(el).find(".timer").html('已结束');
	    			clearInterval(downTimer);
	    		}
	    	},1000);
	    });
    });


	/*团免列表*/
    $(document).on("pageInit", "#page-freeList", function(e, pageId, page) {
    	fn_pull(page);
    });


	/*选择拼团*/
    $(document).on("pageInit", "#page-proList", function(e, pageId, page) {
    	fn_pull(page);
    });


	/*拼团提示页*/
    $(document).on("pageInit", "#page-proTips", function(e, pageId, page) {
    	//倒计时
    	(function(){
    		var time = parseInt($("#downTime").attr("data-timer"));
	    	$("#downTime").html(timeToDate(time));
	    	var downTimer = setInterval(function(){
	    		--time;
	    		$("#downTime").html(timeToDate(time));
	    		if(time<=0){
	    			$("#downTime").parent().html('本团已结束');
	    			clearInterval(downTimer);
	    		}
	    	},1000);
    	})();
    });


	/*猜价格-商品列表*/
    $(document).on("pageInit", "#page-guessList", function(e, pageId, page) {
    	fn_pull(page);

    	//倒计时
    	$(".downTime").each(function(index, el) {
    		var time = parseInt($(el).attr("data-timer"));
	    	$(el).html(timeToDate(time, true));
	    	var downTimer = setInterval(function(){
	    		--time;
	    		$(el).html(timeToDate(time, true));
	    		if(time<=0){
	    			$(el).parent().html('已结束');
	    			clearInterval(downTimer);
	    		}
	    	},1000);
    	});
    });


	/*猜价格-参与用户列表*/
    $(document).on("pageInit", "#page-guessJoinList", function(e, pageId, page) {
    	if($(".guessTab").length>0){
    		fn_click_tab();
    	}else{
    		fn_click();
    	}
    });


	/*猜价格-详情页*/
    $(document).on("pageInit", "#page-guessDeta", function(e, pageId, page) {
    	//弹窗
    	if($(".popup-guessCoupon").length>0){
    		$.popup('.popup-guessCoupon');
    	}

    	//产品banner
    	swiperDetaBanner = new Swiper('.deta-banner', {
	        spaceBetween: 0,
	        pagination: '.swiper-pagination',
	        observer: true
	    });

	    //倒计时
    	(function(){
    		var time = parseInt($("#downTime").attr("data-timer"));
	    	$("#downTime").html(timeToDate(time, 2));
	    	var downTimer = setInterval(function(){
	    		--time;
	    		$("#downTime").html(timeToDate(time, 2));
	    		if(time<=0){
	    			$("#downTime").html('已结束');
	    			clearInterval(downTimer);
	    		}
	    	},1000);
    	})();
    });



    $.init();
});


function timeToDate(_diff, type){
	var _hour = parseInt(_diff / 3600);
	_diff = _diff % 3600;
	var _minute = parseInt(_diff / 60);
	var _second = _diff % 60;
	_hour = (_hour < 10) ? "0"+_hour : _hour;
	_minute = (_minute < 10) ? "0"+_minute : _minute;
	_second = (_second < 10) ? "0"+_second : _second;
	if(type == 1){
		return '<span>' + _hour + '</span>:<span>' + _minute + '</span>:<span>' + _second + '</span>';
	}else if(type == 2){
		return '<span>' + _hour + '</span>时<span>' + _minute + '</span>分<span>' + _second + '</span>秒';
	}else{
		return _hour + ':' + _minute + ':' + _second;
	}
}


/*上拉加载函数*/
function fn_pull(page){
	var bt = baidu.template;
	baidu.template.ESCAPE = false;
	var pageNow = 1,
		pageCount = 2,
		url = $(".pullbox").attr("data-href");
	$(".pullbox").attr("data-pageNow", pageNow);
	$(".pullbox").attr("data-pageCount", pageCount);
	getData(pageNow, pageCount, url);

	// 注册'infinite'事件处理函数
    $(page).on('infinite', function() {
    	pageNow = $(".pullbox").attr("data-pageNow"),
		pageCount = $(".pullbox").attr("data-pageCount"),
		url = $(".pullbox").attr("data-href");

        // 如果正在加载，则退出
        if (loading) return;

        // 设置flag
        loading = true;

        getData(pageNow, pageCount, url);

    });

    function getData(pageNow, pageCount, url){
    	$.ajax({
        	url: url,
        	type: 'POST',
        	dataType: 'json',
        	data: {
        		page: pageNow
        	},
        	success: function(res){

			    var html=bt('tpl_pull',res);
			    $(".pullbox>.list-container").append(html);
		        //容器发生改变,如果是js滚动，需要刷新滚动
		        $.refreshScroller();
			    	

		        // 重置加载flag
		        loading = false;
		        pageCount = res.data.pageCount,
				pageNow = res.data.pageNow;
		    	$(".pullbox").attr("data-pageNow", pageNow+1);
				$(".pullbox").attr("data-pageCount", pageCount);

		        if (pageNow >= pageCount) {
		            // 加载完毕，则注销无限加载事件，以防不必要的加载
		            $.detachInfiniteScroll($('.infinite-scroll'));
		            // 删除加载提示符
		            $('.infinite-scroll-preloader').remove();
		            return;
		        }

        	}
        });
    }
}


/*点击加载函数*/
function fn_click(){
	var bt = baidu.template;
	baidu.template.ESCAPE = false;
	var pageNow = 1,
		pageCount = 2,
		url = $(".clickbox").attr("data-href");
	$(".clickbox").attr("data-pageNow", pageNow);
	$(".clickbox").attr("data-pageCount", pageCount);
	getData(pageNow, pageCount, url);

	// 注册'infinite'事件处理函数
    $(".clickbtn").on('click', function() {
    	pageNow = $(".clickbox").attr("data-pageNow"),
		pageCount = $(".clickbox").attr("data-pageCount"),
		url = $(".clickbox").attr("data-href");

        // 如果正在加载，则退出
        if (loading) return;

        // 设置flag
        loading = true;

        getData(pageNow, pageCount, url);

    });

    function getData(pageNow, pageCount, url){
    	$('.infinite-scroll-preloader').show();
    	$.ajax({
        	url: url,
        	type: 'POST',
        	dataType: 'json',
        	data: {
        		page: pageNow
        	},
        	success: function(res){
	            

        	}
        });

        var res = {
        	msg: '成功',
        	data: {
    			pageNow: 1,
        		pageCount: 1,
        		listData: [
            		{
            			id: '0',
            			name: '智库WISDOM WAREHOUSE 吸吸乐儿童',
            			sales: 2138,
            			num: 2,
            			price: 29.9,
            			oldPrice: 59,
            			imgSrc: 'images/img/index-pro.jpg'
            		},
            		{
            			id: '1',
            			name: '智库WISDOM WAREHOUSE 吸吸乐儿童1111',
            			sales: 2138,
            			num: 2,
            			price: 29.9,
            			oldPrice: 59,
            			imgSrc: 'images/img/index-pro.jpg'
            		}
            	]
        	}
        }

	    var html=bt('tpl_click',res);
	    $(".clickbox>.list-container").append(html);
	    $('.infinite-scroll-preloader').hide();
        //容器发生改变,如果是js滚动，需要刷新滚动
        $.refreshScroller();
	    	

        // 重置加载flag
        loading = false;
        pageCount = res.data.pageCount,
		pageNow = res.data.pageNow;
    	$(".clickbox").attr("data-pageNow", pageNow+1);
		$(".clickbox").attr("data-pageCount", pageCount);

        if (pageNow >= pageCount) {
            $('.infinite-scroll-preloader,.clickbtn').remove();
            return;
        }
    }
}

/*tab点击加载函数*/
function fn_click_tab(){
	var bt = baidu.template;
	baidu.template.ESCAPE = false;
	var pageNow = 1,
		pageCount = 2,
		url = $(".guessTab").attr("data-href");
	$(".guessTab li").attr("data-pageNow", pageNow);
	$(".guessTab li").attr("data-pageCount", pageCount);

    $(".guessTab li").on('click', function() {
    	$(".guessTab li").removeClass("active");
    	$(this).addClass("active");
    	$(".clickbox>.list-container").html('');
    	$('.infinite-scroll-preloader').show();
    	var obj = $(".guessTab li.active");
    	pageNow = 1,
		pageCount = 2,
		url = $(".guessTab").attr("data-href"),
		type = obj.attr("data-type");

        if(!!xhr){
        	xhr.abort();
        }

        getData(type, pageNow, pageCount, url);
    });
	$(".guessTab li").eq(0).trigger("click");

    $(".clickbtn").on('click', function() {
    	var obj = $(".guessTab li.active");
    	pageNow = obj.attr("data-pageNow"),
		pageCount = obj.attr("data-pageCount"),
		url = $(".guessTab").attr("data-href"),
		type = obj.attr("data-type");

        // 如果正在加载，则退出
        if (loading) return;

        // 设置flag
        loading = true;

        getData(type, pageNow, pageCount, url);
    });

    function getData(type, pageNow, pageCount, url){
    	$('.infinite-scroll-preloader').show();
    	xhr = $.ajax({
        	url: url,
        	type: 'POST',
        	dataType: 'json',
        	data: {
        		page: pageNow,
        		type: type
        	},
        	success: function(res){
	            

        	}
        });

        var res = {
        	msg: '成功',
        	data: {
    			pageNow: 1,
        		pageCount: 2,
        		listData: [
            		{
            			id: '0',
            			name: '智库WISDOM WAREHOUSE 吸吸乐儿童',
            			sales: 2138,
            			num: 2,
            			price: 29.9,
            			oldPrice: 59,
            			imgSrc: 'images/img/index-pro.jpg'
            		},
            		{
            			id: '1',
            			name: '智库WISDOM WAREHOUSE 吸吸乐儿童1111',
            			sales: 2138,
            			num: 2,
            			price: 29.9,
            			oldPrice: 59,
            			imgSrc: 'images/img/index-pro.jpg'
            		}
            	]
        	}
        }

	    var html=bt('tpl_click',res);
	    $(".clickbox>.list-container").append(html);
	    $('.infinite-scroll-preloader').hide();
        //容器发生改变,如果是js滚动，需要刷新滚动
        $.refreshScroller();
	    	

        // 重置加载flag
        loading = false;
        pageCount = res.data.pageCount,
		pageNow = res.data.pageNow;
    	$(".guessTab li.active").attr("data-pageNow", pageNow+1);
		$(".guessTab li.active").attr("data-pageCount", pageCount);

        if (pageNow >= pageCount) {
            $('.infinite-scroll-preloader,.clickbtn').hide();
            return;
        }
    }
}
