var xhr = null;
$(function() {
	// $(".bar-nav .back").on("click", function(){
	// 	history.back(-1);
	// });

	//返回顶部
	if($("#goTop").length<=0){
		$(".page-group").append('<section id="goTop" class="goTop"></section>');
	}
	$.fn.scrollTo =function(options){
        var defaults = {
            toT : 0,    //滚动目标位置
            durTime : 300,  //过渡动画时间
            delay : 30,     //定时器时间
            callback:null   //回调函数
        };
        var opts = $.extend(defaults,options),
            timer = null,
            _this = this,
            curTop = _this.scrollTop(),//滚动条当前的位置
            subTop = opts.toT - curTop,    //滚动条目标位置和当前位置的差值
            index = 0,
            dur = Math.round(opts.durTime / opts.delay),
            smoothScroll = function(t){
                index++;
                var per = Math.round(subTop/dur);
                if(index >= dur){
                    _this.scrollTop(t);
                    window.clearInterval(timer);
                    if(opts.callback && typeof opts.callback == 'function'){
                        opts.callback();
                    }
                    return;
                }else{
                    _this.scrollTop(curTop + index*per);
                }
            };
        timer = window.setInterval(function(){
            smoothScroll(opts.toT);
        }, opts.delay);
        return _this;
    };

    $(".content").scroll(function() {
		if($(".content").scrollTop() >= 100 && $('#goTop').length>0){
			$('#goTop').show();
		}else{
			$('#goTop').hide();
		}
	});
	$('#goTop').click(function(){
		$(".content").scrollTo({toT:0});
	});

    //返回首页
    if($("#goIndex").length<=0){
        $(".page-group").append('<a id="goIndex" class="GoIndex" href="index.php"></a>');
        if($("#page-index").length<=0){
            $("#goIndex").show();
        }
    }


	//刷新
	$(document).on("click", ".b-refresh", function(){
		location.href=document.location;
	});
	/*首页*/
    $(document).on("pageInit", "#page-index", function(e, pageId, page) {
        //下载app引导条
        var indexDownHeight = $(".index-download").height();
        $(".index-download .close").on("click", function(){
            $(".index-download").remove();
            $(".content.native-scroll").css("top",$(".index-class").height());
        });
        $(".content.native-scroll").css("top",indexDownHeight+$(".index-class").height());
        $(".index-download .close").on("click", function(){
            $(".index-download").remove();
            $(".content.native-scroll").css("top",$(".index-class").height());
        });
        $(".content").scroll(function() {
            if($(".index-download").length>0){
                if($(".content").scrollTop()>=20){
                    $(".index-download").css("paddingBottom", 0);
                    $(".content.native-scroll").css("top",$(".index-class").height());
                }else{
                    $(".index-download").css("paddingBottom", "13.366%");
                    $(".content.native-scroll").css("top",indexDownHeight+$(".index-class").height());
                }
            }
        })
        // $(".content").scroll(function() {
        //     var downloadHeight = $(".index-download").height();
        //     if(downloadHeight){
        //         $(".index-class-placeholder").hide();
        //     }else{
        //         $(".index-class-placeholder").show();
        //     }
        //     if($(".content").scrollTop() >= downloadHeight){
        //         $(".index-class").addClass("top");
        //     }else{
        //         $(".index-class").removeClass("top");
        //     }
        // });

		var bt = baidu.template;
		baidu.template.ESCAPE = false;
        var ifLoat = true,
        	pageNow = 1;

    	//团免券
    	if($(".popup-coupon").length>0 && !localStorage.freeCoupon){
    		$.popup('.popup-coupon');
    		localStorage.freeCoupon = true;
    	}

    	//分类导航滑动
    	var swiperIndexClass = new Swiper('.index-class', {
            spaceBetween: 0,
            freeMode : true,
            slidesPerView : 'auto'
        });

        //生成对应的页面(首页/分类产品)
        var classId = GetRequest("id"),
            html = '';
        classId = !classId ? 0 : classId;
        if(classId == 0){
            html=bt('tpl_indexBox', {});
        }else{
            html=bt('tpl_proBox', {});
			$("#redPacked").remove();
        }
        $(".index-page").html(html);

        //预先加载
        $(".index-class a").each(function(index, el) {
            var cid = $(el).attr("data-id");
            if(cid == classId){
                swiperIndexClass.slideTo(index, 0, true);
                $(".index-class .swiper-wrapper>a").removeClass("active").eq(index).addClass("active");
            }
        });
        getData(classId);

        // 注册'infinite'事件处理函数
        $(page).on('infinite', function() {
        	var classId = $(".index-class .swiper-wrapper>a.active").attr("data-id");

            // 如果正在加载，则退出
            if (!ifLoad) return;

            getData(classId);

        });

        function getData(classId){
        	ifLoad = 0;
        	$(".index-page .infinite-scroll-preloader").show();
        	$.ajax({
            	url: $(".index-page").attr("data-href"),
            	type: 'POST',
            	dataType: 'json',
            	data: {
            		id: classId,
            		page: pageNow
            	},
            	success: function(res){
					if(res.code>0){
						if(classId == 0){
	            			var bannerHtml=bt('tpl_indexBanner',res);
	            			$(".index-banner .swiper-wrapper").html(bannerHtml);
	            			swiperIndexBanner = new Swiper('.index-banner', {
						        spaceBetween: 0,
						        pagination: '.swiper-pagination',
						        autoplay : 5000,
						        observer: true
						    });
	            			var proHtml=bt('tpl_indexPro',res);
	            			$("#index_page").find('.infinite-scroll-bottom .list-container').append(proHtml);
	            		}else{
	            			var proHtml=bt('tpl_indexClass',res);
	            			$("#index_page").find('.infinite-scroll-bottom .list-container').append(proHtml);

                            // 二级菜单超过八个,显示"..."
                            var subClassNum = $(".index-subClass li").length;
                            var classMoreHref = $(".index-subClass").attr("data-more");
                            var maxSubClassNum = 8;
                            if(subClassNum > maxSubClassNum) {
                                $(".index-subClass li").each(function(index, el) {
                                    if((index+2) > maxSubClassNum){
                                        $(el).remove();
                                    }
                                });
                                $(".index-subClass ul").append('<li><a href="'+classMoreHref+'"><div class="img"><img src="images/subClass-more.png" /></div><div class="txt">查看全部</div></a></li>');
                            }
	            		}

            			// if(res["data"]["proData"]["pageNow"]>1 && res["data"]["proData"]["listData"].length<=0){
            			// 	$.toast("没有更多商品");
            			// }

			            ifLoad = res["data"]["proData"]["ifLoad"];
	        			pageNow = res["data"]["proData"]["pageNow"] + 1;
					}else{
						// $.toast(res.msg);
						// if($("#errorTips").length<=0){
		    // 				$("#index_page_" + index_page).find('.infinite-scroll-bottom .list-container').append('<div id="errorTips">'+ res.msg +',<span class="b-refresh">点击刷新</span></div>');
		    // 			}else{
		    // 				$("#errorTips").html(res.msg +',<span class="b-refresh">点击刷新</span>');
		    // 			}
					}
		            //容器发生改变,如果是js滚动，需要刷新滚动
		            $.refreshScroller();
					$(".index-page .infinite-scroll-preloader").hide();

            	}
            });
        }

        //返回第一屏
        $("#goIndex").on("click", function(){
            swiperIndexPage.slideTo(0, 400, true);
            return false;
        });

        //红包弹窗
        $("#redPacked").on("click", function(){
			$.popup(".popup-red");
        });

		$(".popup-red .go").on("click", function(){
			$.getJSON('hb.php', {}, function(req){
				if(req.code>=1 && req.data.data != 'index.php'){
					$.alert(req.msg, function(){
						location.href = req.data.data;
					});
				}else if(req.code>=1 && req.data.data == 'index.php'){
					$.toast(req.msg);
					$.closeModal(".popup-red");
				}
			});
		});

    });


	/*详情页*/
    $(document).on("pageInit", "#page-deta", function(e, pageId, page) {
    	//产品banner
    	swiperDetaBanner = new Swiper('.deta-banner', {
	        spaceBetween: 0,
	        pagination: '.deta-banner .swiper-pagination',
	        observer: true,
	        autoplay: 5000
	    });

        $(".deta-banner .swiper-slide").on("click", function(){
            if($(".popup-deta-banner").length>0){
                $(".popup-deta-banner").show();
            }else{
                //生成轮播大图
                var banImg = [];
                $('.deta-banner .swiper-slide').each(function(index, el) {
                    banImg.push($(el).find("img").attr("src"));
                });
                var banBigHtml = '<div class="popup-deta-banner"><section class="swiper-container deta-banner-big"><div class="swiper-wrapper">';
                for(var item in banImg){
                    banBigHtml += '<div class="swiper-slide"><img src="' + banImg[item] + '" /></div>';
                }
                banBigHtml += '</div><div class="swiper-pagination"></div></section></div>';
                $(".page-group").append(banBigHtml);
                swiperDetaBannerBig = new Swiper('.deta-banner-big', {
                    spaceBetween: 0,
                    pagination: '.deta-banner-big .swiper-pagination',
                    paginationClickable :true
                });
                $(".deta-banner-big .swiper-pagination .swiper-pagination-bullet").each(function(index, el) {
                    $(el).append('<img src="'+ banImg[index] +'" />');
                });
            }
            var index = $(".deta-banner .swiper-slide").index($(this));
            swiperDetaBannerBig.slideTo(index, 0, true);
        })
        $(document).on("click", ".deta-banner-big .swiper-slide", function(){
            $(".popup-deta-banner").hide();
        });


	    //倒计时
	    $(".deta-group .list li").each(function(index, el) {
	    	var time = parseInt($(el).find(".timer").attr("data-timer"));
	    	$(el).find(".timer span").html(timeToDate(time));
	    	var downTimer = setInterval(function(){
	    		--time;
	    		$(el).find(".timer span").html(timeToDate(time));
	    		if(time<=0){
	    			$(el).find(".timer").html('<span class="themeColor">已结束</span>');
	    			clearInterval(downTimer);
	    		}
	    	},1000);
	    });

	    //分享
	    $(".deta-share").on("click", function(){
	    	$.popup(".popup-share");
	    });
    });


	/*团免列表*/
    $(document).on("pageInit", "#page-freeList", function(e, pageId, page) {
    	fn_pull(page);
    });


	/*选择拼团*/
    $(document).on("pageInit", "#page-proList", function(e, pageId, page) {
    	fn_pull(page);
    });


	/*拼团提示页*/
    $(document).on("pageInit", "#page-proTips", function(e, pageId, page) {
    	//倒计时
    	(function(){
    		var time = parseInt($("#downTime").attr("data-timer"));
	    	$("#downTime").html(timeToDate(time, 1));
	    	var downTimer = setInterval(function(){
	    		--time;
	    		$("#downTime").html(timeToDate(time, 1));
	    		if(time<=0){
	    			$("#downTime").parent().html('<span class="themeColor">本团已结束</span>');
	    			clearInterval(downTimer);
	    		}
	    	},1000);
    	})();

    	//分享弹窗
    	if($(".popup-share").length>0 && $("#showShare").length>0){
    		$.popup(".popup-share");
    	}
        $("#share").on("click", function(){
            $.popup(".popup-share");
        });

        //红包弹窗
        $("#redPacked").on("click", function(){
			$.popup(".popup-red");
        });

        $(".popup-red .go").on("click", function(){
			$.getJSON('hb.php', {}, function(req){
				if(req.code>=1 && req.data.data != 'index.php'){
					$.alert(req.msg, function(){
						location.href = req.data.data;
					});
				}else if(req.code>=1 && req.data.data == 'index.php'){
					$.toast(req.msg);
					$.closeModal(".popup-red");
				}
			});
		});
    });


	/*猜价格-商品列表*/
    $(document).on("pageInit", "#page-guessList", function(e, pageId, page) {
    	$("#rule").on("click", function(){
    		$.popup(".popup-rule");
    	});

    	fn_pull(page, function(){
    		//倒计时
	    	$(".downTime").not(".ed").each(function(index, el) {
	    		var time = parseInt($(el).attr("data-timer"));
		    	$(el).html(timeToDate(time, true));
		    	$(el).addClass("ed");
		    	var downTimer = setInterval(function(){
		    		--time;
		    		$(el).html(timeToDate(time, true));
		    		if(time<=0){
		    			$(el).parent().html('<span class="themeColor">已结束</span>');
		    			clearInterval(downTimer);
		    		}
		    	},1000);
	    	});
    	});
    });


	/*猜价格-参与用户列表*/
    $(document).on("pageInit", "#page-guessJoinList", function(e, pageId, page) {
    	var index = parseInt(GetRequest('type'));
    	switch (index){
    		case 1: 				//一等奖
    			index = 0;
    			break;
    		case 2: 				//二等奖
    			index = 1;
    			break;
    		case 3: 				//三等奖
    			index = 2;
    			break;
    		default: 				//默认一等奖
    			index = 0;
    			break;
    	}

    	if($(".guessTab").length>0){
    		fn_click_tab(index);
    	}else{
    		fn_click();
    	}
    });


	/*猜价格-详情页*/
    $(document).on("pageInit", "#page-guessDeta", function(e, pageId, page) {
    	//弹窗
    	// if($(".popup-guessCoupon").length>0 && !localStorage.guessCoupon){
    	// 	$.popup('.popup-guessCoupon');
    	// 	localStorage.guessCoupon = true;
    	// }

    	//产品banner
    	swiperDetaBanner = new Swiper('.deta-banner', {
	        spaceBetween: 0,
	        pagination: '.swiper-pagination',
	        observer: true
	    });

	    //倒计时
    	(function(){
    		var time = parseInt($("#downTime").attr("data-timer"));
	    	$("#downTime").html(timeToDate(time, 2));
	    	var downTimer = setInterval(function(){
	    		--time;
	    		$("#downTime").html(timeToDate(time, 2));
	    		if(time<=0){
	    			$("#downTime").html('<div class="themeColor">已结束</div>');
	    			clearInterval(downTimer);
	    		}
	    	},1000);
    	})();

    	//参与
    	// $("#guess-join").on("click", function(){
    	// 	$.popup('.popup-join');
    	// });
    	//填写地址
    	$("#guess-address").on("click", function(){
    		$.popup('.popup-address');
    	});
    	if($("#city-picker").length>0){
    		$("#city-picker").cityPicker({
				toolbarTemplate: '<header class="bar bar-nav">\
								<button class="button button-link pull-right close-picker">确定</button>\
								<h1 class="title">选择收货地址</h1>\
								</header>'
			});
    	}
    });


	/*订单确认*/
    $(document).on("pageInit", "#page-orderCofirm", function(e, pageId, page) {

    	//支付方式
    	$(".oc-pay li input").each(function(index, el) {
			if($(el).is(":checked")){
				$(el).parent().addClass("active");
			}
		});
    	$(".oc-pay input").on("change", function(){
    		$(this).parents(".oc-pay").find("li").removeClass("active");
    		$(this).parents(".oc-pay").find("input").each(function(index, el) {
    			if($(el).is(":checked")){
    				$(el).parent().addClass("active");
    			}
    		});
    	});
    });


	/*搜索*/
    $(document).on("pageInit", "#page-search", function(e, pageId, page) {
    	//清除文字
    	$(".bar-search .clearTxt").on("click", function(){
    		$(this).parents("form").find("input").val('');
    	});

    	//搜索历史
		writeHistory();
		$("#searchForm").on("submit",function(){
			if(!localStorage.search_history){
				localStorage.search_history = "";
			}
			var txt = $(".bar-search input").val();
			if(txt != ''){
				var history = localStorage.search_history.split("@#/");
				var ifAdd = true;
				for(var i = 0; i < history.length-1; i++){
					if(history[i] == txt){
						ifAdd = false;
					}
				}
				ifAdd ? localStorage.search_history += txt + "@#/" : "";
			}

		});
		// 清除记录
		$(".search-history a.del").on("click",function(){
			localStorage.search_history = "";
			writeHistory();
		});
		function writeHistory(){
			var historyHtml = "";
			var url = $(".search-history .list").attr("data-href");
			if(localStorage.search_history){
				var history = localStorage.search_history.split("@#/");
				for(var i = 0; i < history.length-1; i++){
					var txt = history[i];
					if(txt.length>7){
						txt = txt.substring(0,7);
						txt += '...';
					}
					historyHtml += "<a href='" + url + history[i] +"'>"+ txt +"</a>"
				}
				$(".search-history .list").html(historyHtml);
			}else{
				$(".search-history .list").html('<div class="tips-null">暂无搜索记录</div>');
			}
		}

		//加载
		if($(".pullbox").length>0){
			fn_pull(page);
		};
    });


	/*个人中心*/
    $(document).on("pageInit", "#page-user", function(e, pageId, page) {

    });


	/*个人中心-收藏*/
    $(document).on("pageInit", "#page-collection", function(e, pageId, page) {
    	fn_pull(page);
    });


	/*个人中心-地址*/
    $(document).on("pageInit", "#page-address", function(e, pageId, page) {
    	fn_pull(page);

   //  	if($("#city-picker").length>0){
   //  		$("#city-picker").cityPicker({
			// 	toolbarTemplate: '<header class="bar bar-nav">\
			// 					<button class="button button-link pull-right close-picker">确定</button>\
			// 					<h1 class="title">选择收货地址</h1>\
			// 					</header>'
			// });
   //  	}
    });


	/*个人中心-猜价*/
    $(document).on("pageInit", "#page-guess", function(e, pageId, page) {
    	var index = parseInt(GetRequest('type'));
    	fn_pull_tab(page,index);
    });


	/*个人中心-优惠券*/
    $(document).on("pageInit", "#page-coupon", function(e, pageId, page) {
    	fn_pull_tab(page);

    	$(document).on("click", ".user-coupon .freeCoupon.invalid", function(){
    		return false;
    	});
    });


	/*个人中心-订单列表*/
    $(document).on("pageInit", "#page-orderList", function(e, pageId, page) {
    	var index = location.search;
    	var num = index.indexOf("=");
    	index = parseInt(index.substring(num+1));
    	switch (index){
    		case 1: 				//待付款
    			index = 1;
    			break;
    		case 2: 				//拼团中
    			index = 2;
    			break;
    		case 21: 				//代发货
    			index = 3;
    			break;
    		case 3: 				//待收货
    			index = 4;
    			break;
    		case 4: 				//已完成
    			index = 5;
    			break;
    		default: 				//默认全部
    			index = 0;
    			break;
    	}
    	fn_pull_tab(page,index);
    });


	/*售后*/
    $(document).on("pageInit", "#page-afterSales", function(e, pageId, page) {
    	var index = parseInt(GetRequest('type'));
    	fn_pull_tab(page,index);

	    //图片预览
	  //   $(document).on("change", ".uploadImg input" ,function(){
	  //   	var _this = $(this);
			// var url = _this.val();
			// if (window.createObjectURL != undefined) { // basic
			// 	url = window.createObjectURL(_this.get(0).files[0]);
			// } else if (window.URL != undefined) { // mozilla(firefox)
			// 	url = window.URL.createObjectURL(_this.get(0).files[0]);
			// } else if (window.webkitURL != undefined) { // webkit or chrome
			// 	url = window.webkitURL.createObjectURL(_this.get(0).files[0]);
			// }
			// if(_this.next().hasClass("noImg")){
   //          	_this.next().removeClass("noImg");
   //          	_this.next().html('<img src="'+ url +'" />');
   //          	if(_this.parents(".uploadImg").find(".uploadImg-item").length >= 3) return;
   //          	_this.parent().after('<div class="uploadImg-item"><input type="file" capture="camera" accept="image/*" name="" /><div class="img noImg"></div></div>');
   //          }else{
   //          	_this.next().find("img").attr("src", url);
   //          }
   //  	});


    	//价格限制
        $("#price").on("keyup", function(){
            var val = $(this).val();
            val = val.replace(/[^.\d]/g,'');
            $(this).val(val);
        });
    	$("#price").on("change", function(){
    		var max = parseFloat($(this).attr("data-max"));
    		var now = parseFloat($(this).val());
    		if(now>max){
    			$.toast('退款金额不能超过' + max);
    			$(this).val(max);
    		}
    	});
    });


	/*我的团*/
    $(document).on("pageInit", "#page-myGroup", function(e, pageId, page) {
    	var index = parseInt(GetRequest('type'));
    	fn_pull_tab(page,index);
    });

    /*专题分类*/
    $(document).on("pageInit", "#page-special-class", function(e, pageId, page) {
        var bt = baidu.template;
        baidu.template.ESCAPE = false;
        var ifLoat = true,
            pageNow = 1;

        //初始设置标题
        var pageTitle = $(".special-class .swiper-slide").eq(0).find("span").html();
        $(".bar-nav .title").html(pageTitle);

        //生成左右滑动页面
        $(".special-page>.swiper-wrapper").html('');
        $(".special-class .swiper-wrapper>a").each(function(index, el) {
            var classId = $(el).attr("data-id");
            var html = '<div class="swiper-slide" id="special_page_'+ (index+1) +'">';
            html    += '<div class="swipe-handler swiper-placeholder"></div>'
                     + '<section class="special-index infinite-scroll infinite-scroll-bottom" data-distance="30">'

                     +      '<ul class="list-container"></ul>'
                     +      '<div class="infinite-scroll-preloader swipe-handler">'
                     +          '<div class="preloader"></div>'
                     +      '</div>'
                     +  '</section></div>';
            $(".special-page>.swiper-wrapper").append(html);
            $(".swiper-placeholder").height($(".content.native-scroll").height());
        });
        //页面左右滑动
        var swiperIndexPage = new Swiper('.special-page', {
            spaceBetween: 0,
            touchMoveStopPropagation: false,
            swipeHandler : '.swipe-handler',
            onSlideChangeStart:function(){
                $(".special-page").find('.infinite-scroll-preloader').show();
                $(".special-page").find('.infinite-scroll-bottom .list-container').html('');
            },
            onSlideChangeEnd: function(e){
                var index = swiperIndexPage.activeIndex + 1;
                swiperIndexClass.slideTo(index-1, 400, true);
                $(".special-class .swiper-wrapper>a").removeClass("active").eq(index-1).addClass("active");
                //容器发生改变,如果是js滚动，需要刷新滚动
                $(".special-page").scroller('refresh');

                var pageObj = $(".special-class .swiper-wrapper>a").eq(index-1);
                var classId = pageObj.attr("data-id");

                //设置标题
                var pageTitle = $(".special-class .swiper-slide").eq(index-1).find("span").html();
                $(".bar-nav .title").html(pageTitle);

                // 设置地址
                history.replaceState({id: classId}, '拼得好', 'specials.php?id='+classId)

                ifLoad = true,
                pageNow = 1;
                getData(index, classId);
            }
        });
        //分类导航滑动
        if($('.special-class .swiper-slide').length>1){
        	var specialShowNum = 2;
        }else{
        	var specialShowNum = 1;
        }
        var swiperIndexClass = new Swiper('.special-class', {
            spaceBetween: 0,
            freeMode : true,
            slidesPerView : specialShowNum,
            onSlideChangeEnd: function(){
                var index = swiperIndexPage.activeIndex;
                swiperIndexPage.slideTo(index, 400, true);
            }
        });
        //点击分类导航页面左右滑动
        $(".special-class .swiper-wrapper>a").on("click", function(){
            var index = $(".special-class .swiper-wrapper>a").index(this);
            swiperIndexPage.slideTo(index, 400, true);
        });

        //预先加载
        // if(!localStorage.specialsId || localStorage.specialsId == 'null'){
        //     if(!GetRequest('id') || GetRequest('id')==''){
        //         specialsId = $(".special-class a").eq(0).attr("data-id");
        //     }else{
        //         specialsId = GetRequest('id');
        //     }
        // }else{
        // 	specialsId = localStorage.specialsId;
        // }
        if(!GetRequest('id') || GetRequest('id')==''){
            specialsId = $(".special-class a").eq(0).attr("data-id");
        }else{
            specialsId = GetRequest('id');
        }
        var specialsFlag = true;
        $(".special-class .swiper-wrapper>a").each(function(index, el) {
        	if($(el).attr("data-id") == specialsId){
        		if(index == 0){
        			getData(1, specialsId);
        		}else{
        			swiperIndexPage.slideTo(index, 0, true);
        		}
                specialsFlag = false;
        	}
        });
        if(specialsFlag) getData(1, $(".special-class .swiper-wrapper>a").eq(0).attr("data-id"));

        //
        // $(document).on("click","a",function(){
        // 	if($(this).parents(".special-item").length>0){
        // 		localStorage.specialsId = $(".special-class .swiper-wrapper>a.active").attr("data-id");
        // 	}else if($(this).parents('.special-class').length>0){
        //         localStorage.specialsId = $(this).attr("data-id");
        //     }else{
        //         localStorage.specialsId = null;
        //     }
        // });

        // 注册'infinite'事件处理函数
        $(page).on('infinite', function() {
            var pageIndex = $(".special-class a").index($(".special-class a.active"))+1,
                classId = $(".special-class .swiper-wrapper>a.active").attr("data-id");
            // 如果正在加载，则退出
            if (!ifLoad) return;

            getData(pageIndex, classId);

        });

        function getData(index_page, classId){
        	ifLoad = 0;
            $(".special-page>.swiper-wrapper>.swiper-slide-active .infinite-scroll-preloader").show();
            $.ajax({
                url: $(".special-page").attr("data-href"),
                type: 'POST',
                dataType: 'json',
                data: {
                    id: classId,
                    page: pageNow
                },
                success: function(res){
                    if(res.code>0){
                        var proHtml=bt('tpl_indexClass',res);
                        $("#special_page_" + index_page).find('.infinite-scroll-bottom .list-container').append(proHtml);
                        $(".downTime").not(".ed").each(function(index, el) {
                            var time = parseInt($(el).attr("data-timer"));
                            $(el).html(timeToDate(time, 1));
                            $(el).addClass("ed");
                            var downTimer = setInterval(function(){
                                --time;
                                $(el).html(timeToDate(time, 1));
                                if(time<=0){
                                    $(el).parent().html('已结束');
                                    clearInterval(downTimer);
                                }
                            },1000);
                        });
                        // if(res["data"]["pageNow"]>1 && res["data"]["data"].length<=0){
                        //     $.toast("没有更多商品");
                        // }

                        ifLoad = res["data"]["ifLoad"];
                        pageNow = res["data"]["pageNow"] + 1;
                    }else{
                        ifLoad = res["data"]["ifLoad"];
                    	// $.toast(res.msg);
                        // if($("#errorTips").length<=0){
                        //     $("#special_page_" + index_page).find('.infinite-scroll-bottom .list-container').append('<div id="errorTips">'+ res.msg +',<span class="b-refresh">点击刷新</span></div>');
                        // }else{
                        //     $("#errorTips").html(res.msg +',<span class="b-refresh">点击刷新</span>');
                        // }
                    }
                    //容器发生改变,如果是js滚动，需要刷新滚动
                    $.refreshScroller();
                    $(".special-page>.swiper-wrapper>.swiper-slide-active .infinite-scroll-preloader").hide();

                    //设置分享内容
                    imgUrl = res["data"]["data"]["fx"]["image"];
                    link = res["data"]["data"]["fx"]["url"];
                    title = res["data"]["data"]["fx"]["title"];
                    desc = res["data"]["data"]["fx"]["content"];
                    wxshare(false, wxappId, wxtimestamp, wxnonceStr, wxsignature, imgUrl, link, title ,desc);
                }
            });
        }

    });

	/*专题列表*/
	$(document).on("pageInit", "#page-special-list", function(e, pageId, page) {
        //倒计时
        var time = parseInt($("#downtime").attr("data-timer"));
        $("#downtime").html(timeToDate(time, 3));
        var downTimer = setInterval(function(){
            --time;
            $("#downtime").html(timeToDate(time, 3));
            if(time<=0){
                $("#downtime").html('已结束');
                clearInterval(downTimer);
            }
        },1000);

        fn_pull(page);

        $(".share").on("click", function(){
            $.popup(".popup-share");
        });
    });

	/*专题列表*/
	$(document).on("pageInit", "#page-pdkFreeLink", function(e, pageId, page) {
        $(".share").on("click", function(){
            $.popup(".popup-share");
        });
    });


    /*交易记录列表*/
    $(document).on("pageInit", "#page-pdk-record", function(e, pageId, page) {
        fn_pdkRecord_pull(page);
	    $(".pdkRecord-search .btn input").on("click", function(){
	        searchReq = {page: 1};
	        $(".pdkRecord-search input[rel='req']").each(function(index, el) {
	            var key = $(el).attr("name"),
	                value = $(el).val();
	            searchReq[key] = value;
	        });
	        var startTime = searchReq["startTime"],
	        	endTime = searchReq["endTime"];
	        if(!!startTime){
		        startTime = startTime.replace(/\//g, ',');
		        startTime += ':0:0';
		        startTime = new Date(startTime).getTime();
	        }
	        if(!!endTime){
		        endTime = endTime.replace(/\//g, ',');
		        endTime += ':0:0';
		        endTime = new Date(endTime).getTime();
	        }
	        if(!!endTime && !!startTime && startTime>endTime){
        		$.toast("结束时间不能晚于开始时间");
        		return false;
	        }


	        $(".pullbox>.list-container").html("");
	        fn_pdkRecord_pull(page);
	    });
        function fn_pdkRecord_pull(page){
            var bt = baidu.template;
            baidu.template.ESCAPE = false;
            var pageNow = 1,
                ifLoad = 1,
                url = $(".pullbox").attr("data-href");

            searchReq = {page: 1};
            $(".pdkRecord-search input[rel='req']").each(function(index, el) {
                var key = $(el).attr("name"),
                    value = $(el).val();
                searchReq[key] = value;
            });
            getData(url, searchReq);

            // 注册'infinite'事件处理函数
            $(page).on('infinite', function() {
                ifLoad = $(".pullbox").attr("data-ifLoad"),
                url = $(".pullbox").attr("data-href");

                // 如果正在加载，则退出
                if (!ifLoad) return;

                getData(url, searchReq);

            });

            function getData(url){
                $('.infinite-scroll-preloader').show();

                $.ajax({
                    url: url,
                    type: 'POST',
                    dataType: 'json',
                    data: searchReq,
                    success: function(res){
		                $('.infinite-scroll-preloader').hide();
		                var html=bt('tpl_pull',res);
		                $(".pullbox>.list-container").append(html);
		                var act = GetRequest("act");

		                if(act == "incomes"){
		                	var totalPrice = res.data.data.rePrice;
		                }else{
		                	var totalPrice = res.data.data.wdPrice;
		                }
		                if(totalPrice=="" || totalPrice == null){
		                	totalPrice = 0;
		                }
		                $(".pdkRecord-list .title1 .themeColor").html("￥" + totalPrice);

		                //容器发生改变,如果是js滚动，需要刷新滚动
		                $.refreshScroller();

		                ifLoad = res.data.ifLoad,
		                pageNow = res.data.pageNow;
		                searchReq["page"] = pageNow+1;
		                $(".pullbox").attr("data-ifLoad", ifLoad);

		                if (!ifLoad) {
		                    // 加载完毕，则注销无限加载事件，以防不必要的加载
		                    $.detachInfiniteScroll($('.infinite-scroll'));
		                    // 删除加载提示符
		                    $('.infinite-scroll-preloader').remove();
		                    return;
		                }

                    }
                });

            }
        }
    });

    /*掌上秒杀*/
    $(document).on("pageInit", "#page-seckill", function(e, pageId, page) {
        $(".share").on("click", function(){
            $.popup(".popup-share");
        });
    });

    /*掌上秒杀-售罄商品*/
    $(document).on("pageInit", "#page-seckill-out", function(e, pageId, page) {
        fn_pull(page);
    });

    /*我的抽奖*/
    $(document).on("pageInit", "#page-myLottery", function(e, pageId, page) {
        var type = GetRequest("type"),
            index = 0;
        $(".lottery-tab ul li").each(function(aindex, el) {
            var atype = $(el).attr("data-type");
            if(atype == type){
                index = aindex;
            }
        });
        fn_pull_tab(page,index);
    });

    /*0.1抽奖*/
    $(document).on("pageInit", "#page-lottery", function(e, pageId, page) {
        fn_pull(page);

        $(".share").on("click", function(){
            $.popup(".popup-share");
        });

        $("#rule").on("click", function(){
            $.popup(".popup-rule");
        });
    });

    /*我的抽奖*/
    $(document).on("pageInit", "#page-lotteryresult", function(e, pageId, page) {
        fn_pull(page);
    });

    /*评价列表*/
    $(document).on("pageInit", "#page-evaluate", function(e, pageId, page) {
        fn_pull(page);

        $(document).on("click", ".evaluate-list .imgs>div", function(){
        	var _this = $(this);
        	var imgArr = [];
        	imgArr.push(_this.find("img").attr("src"));
        	$(this).siblings("div").each(function(index, el) {
        		imgArr.push($(el).find("img").attr("src"));
        	});
        	var myPhotoBrowserPopup = $.photoBrowser({
			    photos: imgArr,
			    type: 'popup'
			});
        	myPhotoBrowserPopup.open();
        });

        $(document).on("click", ".photo-browser-popup", function(){
        	$.closeModal(".photo-browser-popup");
        })
    });

    /*分类-二级分类*/
    $(document).on("pageInit", "#page-class", function(e, pageId, page) {
        var class2Arr = [],
            aHeight = 0;
        $(".class-two>dl").each(function(index, el) {
            aHeight += $(el).outerHeight(true);
            class2Arr.push(aHeight);
        });
        var maxScroll = class2Arr[class2Arr.length-1] - $(".class-two").outerHeight(true) + $(".class-two").height()*0.43 -class2Arr[class2Arr.length-1]+class2Arr[class2Arr.length-2];
        $(".class-one li").eq(0).addClass("active");
        $(".class-two").on("scroll", function(){
            var aTop = $(this).scrollTop() + $(".class-two").height()*0.43,
                aHeight = 0,
                aNow = 0;
            for(var i=0; i<class2Arr.length; i++){
                // if(aTop >= maxScroll){
                //     console.log(class2Arr.length);
                //     $(".class-one li").removeClass("active").eq(class2Arr.length-1).addClass("active");
                //     return false;
                // }else
                if($(this).scrollTop() <= 30){
                    $(".class-one li").removeClass("active").eq(0).addClass("active");
                    return false;
                }else if(aTop >= class2Arr[i] && aTop <= class2Arr[i+1]){
                    $(".class-one li").removeClass("active").eq(i+1).addClass("active");
                    return false;
                }
            };
        });
        $(".class-one li").on("click", function(){
            var index = $(".class-one li").index(this);
            $(".class-two").scrollTo({toT:class2Arr[index-1], durTime: 300, callback: function(){
                $(".class-one li").removeClass("active").eq(index).addClass("active");
            }});
        });
    });

    /*分类-分类产品*/
    $(document).on("pageInit", "#page-classGood", function(e, pageId, page) {
        var popHtml = '<div class="pop"><h3 class="title1"><span>分类</span><i></i></h3><ul class="pop-show">';
        $(".class-nav .show>li").each(function(index, el) {
            var type = $(el).attr("data-type"),
                level = $(el).attr("data-level"),
                txt = $(el).find("a").html();
            popHtml += '<li data-type="'+type+'" data-level="'+level+'"><a>'+txt+'</a></li>';
        });
        popHtml += '</ul><div class="pop-mark"></div></div>';
        $(".class-nav").append(popHtml);

        var bt = baidu.template;
        baidu.template.ESCAPE = false;
        var pageNow = 1,
            ifLoad = 1,
            url = $(".user-tab").attr("data-href"),
            id = GetRequest("id"),
            level = GetRequest("level");

        $(".user-tab li").attr("data-pageNow", pageNow);

        $(".user-tab li").on('click', function() {
            $(".user-tab li").removeClass("active");
            $(this).addClass("active");
            $(".clickbox>.list-container").html('');
            $('.infinite-scroll-preloader').show();
            var obj = $(".user-tab li.active");
            pageNow = 1,
            ifLoad = 1,
            id = obj.attr("data-type"),
            level = obj.attr("data-level");

            if(!!xhr){
                xhr.abort();
            }

            getData(url, {type: id, level: level, page: pageNow});
        });
        $(".class-nav .show li").each(function(index, el) {
            var aId = $(el).attr("data-type"),
                aLevel = $(el).attr("data-level");
            if(id===aId && aLevel===level){
                $(".user-tab li").eq(index).trigger("click");
            }
        });


        // 注册'infinite'事件处理函数
        $(page).on('infinite', function() {
            var obj = $(".user-tab li.active");
            pageNow = obj.attr("data-pageNow"),
            ifLoad = parseInt(obj.attr("data-ifLoad")),
            id = obj.attr("data-type"),
            level = obj.attr("data-level");

            // 如果正在加载，则退出
            if (!ifLoad) return;

            $.showIndicator();
            getData(url, {type: id, level: level, page: pageNow});

        });

        function getData(url, data){
            $('.infinite-scroll-preloader').show();
            $(".user-tab li.active").attr("data-ifLoad", 0);
            xhr = $.ajax({
                url: url,
                type: 'POST',
                dataType: 'json',
                data: data,
                success: function(res){

                    if(res.code>0){

                        var html=bt('tpl_pull_tab',res);
                        $(".clickbox>.list-container").append(html);
                        $('.infinite-scroll-preloader').hide();

                        ifLoad = res.data.ifLoad,
                        pageNow = res.data.pageNow;
                        $(".user-tab li.active").attr("data-pageNow", pageNow+1);
                        $(".user-tab li.active").attr("data-ifLoad", ifLoad);

                        if (!ifLoad) {
                            $('.infinite-scroll-preloader,.clickbtn').hide();
                        }

                    }else{

                        if($("#errorTips").length<=0){
                            $(".clickbox>.list-container").append('<div id="errorTips">'+ res.msg +',<span class="b-refresh">点击刷新</span></div>');
                        }else{
                            $("#errorTips").html(res.msg +',<span class="b-refresh">点击刷新</span>');
                        }
                        $('.infinite-scroll-preloader,.clickbtn').hide();

                    }

                    // history.replaceState(null, document.title, 'search_class.php?act=twoClass&id='+data.type+'&level='+data.level);
                    $.hideIndicator();
                    //容器发生改变,如果是js滚动，需要刷新滚动
                    $.refreshScroller();
                    $('.infinite-scroll-preloader').hide();

                }
            });

        }

        $(".class-nav .show-down").on("click", function(){
            var index = $(".class-nav .show li").index($(".class-nav .show li.active"));
            $(".class-nav .pop .pop-show li").removeClass("active").eq(index).addClass("active");
            $(".class-nav .pop").show();
        });
        $(document).on("click", ".class-nav .pop .pop-show li", function(){
            oparent = $(this).parent().find("li");
            var index = oparent.index(this);
            $(".class-nav .show li").removeClass("active").eq(index).addClass("active");
            setCenter();
            $(".class-nav .pop").hide();
        });
        $(document).on("click", ".class-nav .pop .pop-mark,.class-nav .pop .title1 i", function(){
            $(".class-nav .pop").hide();
        });
        $(document).on("click", ".class-nav .show li", function(){
            setCenter()
        });

        function setCenter(){
            var winWidth = $(window).width();
            var offsetLeft = $(".class-nav .show li.active").offset().left;
            $(".class-nav .show").scrollLeft(offsetLeft - winWidth/2);
        }
    });

    /*消息-列表*/
    $(document).on("pageInit", "#page-messageList", function(e, pageId, page) {
        //进入页面定位到底部
        $(".content").scrollTo({
            toT: $(".content .message-list").height(),
            durTime: 0
        });

        //初始设置
        var bt = baidu.template;
        baidu.template.ESCAPE = false;
        $(".message-list").attr("data-page", 1);
        $(".message-list").attr("data-ifLoad", 1);
        getData();

        // 添加'refresh'监听器
        $(document).on('refresh', '.pull-to-refresh-content',getData);

        function getData(){
            $.ajax({
                url: $(".message-list").data("href"),
                data: {
                    page: $(".message-list").data("page")
                },
				dataType: 'json',
                success: function(res){
                    var oldHeight = $(".message-list").height();
                    var html=bt('tpl_pull',res);
                    $(".message-list>ul").prepend(html);
                    $(".message-list").attr("data-page", res.data.pageNow+1);
                    $(".message-list").attr("data-ifLoad", res.data.ifLoad);

                    var newHeight = $(".message-list").height();
                    //滚动到加载前的位置
                    $(".content").scrollTo({
                        toT: newHeight-oldHeight,
                        durTime: 0
                    });

                    $(".infinite-scroll-preloader").hide();
                    // 加载完毕需要重置
                    $.pullToRefreshDone('.pull-to-refresh-content');
                    if (!res.data.ifLoad) {
                        $.destroyPullToRefresh('.pull-to-refresh-content');
                    }
                },
                error: function(res){
                    $.toast("加载失败,请重试");
                }
            });
        }

    });

    /*消息-内容*/
    $(document).on("pageInit", "#page-messageTxt", function(e, pageId, page) {
        $(".share").on("click", function(){
            $.popup(".popup-share");
        });
    });

	/* 资料编辑 */
	$(document).on("pageInit", "#page-userInfo", function(e, pageId, page) {
		// 图片预览
		$(document).on("change", "#photo" ,function(){
			var _this = $(this);
			var url = _this.val();
			if (window.createObjectURL != undefined) { // basic
				url = window.createObjectURL(_this.get(0).files[0]);
			} else if (window.URL != undefined) { // mozilla(firefox)
				url = window.URL.createObjectURL(_this.get(0).files[0]);
			} else if (window.webkitURL != undefined) { // webkit or chrome
				url = window.webkitURL.createObjectURL(_this.get(0).files[0]);
			}
			$("#photoView").attr("src", url);
		});

		// 提交
		$("#save").on("click", function(){
			if($("#name").val() == ""){
				$.toast("请填昵称");
				return false;
			}
			if($("#name").val().length > 14){
				$.toast("昵称不能超过14个字符");
				return false;
			}
			$("#userInfoForm").submit();
		});
	});

    /* 任务列表 */
    $(document).on("pageInit", "#page-taskList", function(e, pageId, page) {
        var reqData = {
            page: 1
        }
        var seckill = pullMore({
            pageId: page,
            container: '.index-seckill .list-container',
            url: $('.index-seckill').data("href"),
            data: reqData,
            tplId: "tpl_pull"
        });
        // 搜索按钮绑定
        $(".search").on("click", function(){
            reqData.name = $.trim($("#search").val());
            // 清除其他参数
            reqData.source = null;
            $('.user-tab li').removeClass('active-type1');
            $('.user-tab li').removeClass('active-type2');
            $('.user-tab li').removeClass('active');
            // $('.user-tab li').eq(0).addClass('active-type1');
            reqData.type1 = null;
            reqData.type2 = null;
            reqData.type3 = null;
            $("#class1").parent().html(resetClassPicker("#class1"));
            $("#class1").parent().next().html(resetClassPicker("#class2"));
            $("#class1").parent().next().next().html(resetClassPicker("#class3"));
            seckill.setReq(reqData);
            $('.index-seckill .list-container').html('');
            seckill.getData();
        });
        // 筛选确定
        $("#screen").on("click", function(){
            seckill.setReq(reqData);
            $('.index-seckill .list-container').html('');
            seckill.getData();
        });
        $(".user-tab li").on("click", function(){
            var _this = $(this);
            if(_this.hasClass("single")){
                var type = _this.data("type");
                _this.siblings('li').removeClass('active');
                _this.siblings('li').removeClass('active-type1');
                _this.siblings('li').removeClass('active-type2');
                _this.addClass("active");
                reqData.source = type;
                seckill.setReq(reqData);
                $('.index-seckill .list-container').html('');
                seckill.getData();
            }else if(_this.hasClass("double")){
                var type = '';
                _this.siblings('li').removeClass('active');
                _this.siblings('li').removeClass('active-type1');
                _this.siblings('li').removeClass('active-type2');
                _this.addClass('active');
                if(_this.hasClass("active-type1")){
                    _this.removeClass("active-type1")
                        .addClass('active-type2');
                    type = _this.data("type2");
                }else{
                    _this.removeClass("active-type2")
                        .addClass('active-type1');
                    type = _this.data("type1");
                }
                reqData.source = type;
                seckill.setReq(reqData);
                $('.index-seckill .list-container').html('');
                seckill.getData();
            }else if(_this.hasClass('out')){
                var classOne = {
                    value: [],
                    id: []
                };
                for(var i=0; i<classJson.length; i++){
                    classOne.value.push(classJson[i]["oneName"]);
                    classOne.id.push(classJson[i]["oneId"]);
                };
                $("#class1").picker({
                    cols: [{textAlign: 'center', values: classOne.value}],
                    onClose: function(e){
                        var OneId = getArrIndex(e.value[0], classOne.value, classOne.id);
                        reqData.type1 = OneId;
                        reqData.type2 = null;
                        reqData.type3 = null;
                        $("#class1").attr("data-id", OneId);
                        $("#class1").parent().next().html(resetClassPicker("#class2"));
                        $("#class1").parent().next().next().html(resetClassPicker("#class3"));
                        var classTwo = {
                            value: [],
                            id: []
                        };
                        var classTowArr = getTwoClass(OneId);
                        for(var j=0; j<classTowArr.length; j++){
                            classTwo.value.push(classTowArr[j]["twoName"]);
                            classTwo.id.push(classTowArr[j]["twoId"]);
                        };
                        $("#class2").picker({
                            cols: [{textAlign: 'center', values: classTwo.value}],
                            onClose: function(e){
                                var OneId = $("#class1").data("id");
                                var TwoId = getArrIndex(e.value[0], classTwo.value, classTwo.id);
                                reqData.type2 = TwoId;
                                reqData.type3 = null;
                                $("#class2").attr("data-id", TwoId);
                                $("#class1").parent().next().next().html(resetClassPicker("#class3"));
                                var classThree = {
                                    value: [],
                                    id: []
                                };
                                var classThreeArr = getThreeClass(OneId, TwoId);
                                for(var j=0; j<classThreeArr.length; j++){
                                    classThree.value.push(classThreeArr[j]["threeName"]);
                                    classThree.id.push(classThreeArr[j]["threeId"]);
                                };
                                $("#class3").picker({
                                    cols: [{textAlign: 'center', values: classThree.value}],
                                    onClose: function(e){
                                        var ThreeId = getArrIndex(e.value[0], classThree.value, classThree.id);
                                        reqData.type3 = ThreeId;
                                        $("#class3").attr("data-id", ThreeId);
                                    }
                                });
                            }
                        });
                    }
                });
                $.popup(".popup-class");
            }
        });

        function getArrIndex(value, arrValue, arrId){
            for(var i=0; i<arrValue.length; i++){
                if(arrValue[i] == value){
                    return arrId[i];
                }
            }
        }

        function getTwoClass(oneId){
            for(var i=0; i<classJson.length; i++){
                if(classJson[i]["oneId"] == oneId){
                    return classJson[i]["twoLevelList"];
                }
            }
        }

        function getThreeClass(oneId, twoId){
            for(var i=0; i<classJson.length; i++){
                if(classJson[i]["oneId"] == oneId){
                    var TwoArr = classJson[i]["twoLevelList"];
                    for(var j=0; j<TwoArr.length; j++){
                        if(TwoArr[j]["twoId"] == twoId){
                            return TwoArr[j]["threeLevelList"];
                        }
                    }
                }
            }
        }

        function resetClassPicker(el){
            var placeholder = $(el).attr("placeholder"),
                id = el.slice(1);
            var html = '<input type="text" id="'+ id +'" placeholder="' + placeholder + '" readonly="readonly" />';
            $(el).remove();
            return html;
        }

    })


    // 懒加载图片
    // $(".native-scroll").on("scroll", function(){
    //     scrollLoad();
    // });
    $.init();
});

function timeToDate(_diff, type){
	var _hour = parseInt(_diff / 3600);
	_diff = _diff % 3600;
	var _minute = parseInt(_diff / 60);
	var _second = _diff % 60;
	_hour = (_hour < 10) ? "0"+_hour : _hour;
	_minute = (_minute < 10) ? "0"+_minute : _minute;
	_second = (_second < 10) ? "0"+_second : _second;
	_hour = _hour.toString();
	_minute = _minute.toString();
	_second = _second.toString();
	if(type == 1){
		return '<span>' + _hour + '</span>:<span>' + _minute + '</span>:<span>' + _second + '</span>';
	}else if(type == 2){
		return '<span>' + _hour + '</span>时<span>' + _minute + '</span>分<span>' + _second + '</span>秒';
	}else if(type == 3){
		var html = '';
		for(var i=0; i<_hour.length; i++){
			html += '<span>'+ _hour[i] +'</span>';
		}
		html += ':';
		for(var i=0; i<_minute.length; i++){
			html += '<span>'+ _minute[i] +'</span>';
		}
		html += ':';
		for(var i=0; i<_second.length; i++){
			html += '<span>'+ _second[i] +'</span>';
		}
		return html;
	}else{
		return _hour + ':' + _minute + ':' + _second;
	}
}

function GetRequest(name) {
    var url = location.search; //获取url中"?"符后的字串
    var theRequest = new Object();
    if (url.indexOf("?") != -1) {
        var str = url.substr(1);
        strs = str.split("&");
        for(var i = 0; i < strs.length; i ++) {
            theRequest[strs[i].split("=")[0]]=unescape(strs[i].split("=")[1]);
        }
    }
    return theRequest[name];
}


/*上拉加载函数*/
function fn_pull(page, fn){
	var bt = baidu.template;
	baidu.template.ESCAPE = false;
	var pageNow = 1,
		ifLoad = 1,
		url = $(".pullbox").attr("data-href");
	$(".pullbox").attr("data-pageNow", pageNow);
	getData(pageNow, url);

	// 注册'infinite'事件处理函数
    $(page).on('infinite', function() {
    	pageNow = $(".pullbox").attr("data-pageNow"),
		ifLoad = parseInt($(".pullbox").attr("data-ifLoad")),
		url = $(".pullbox").attr("data-href");

        // 如果正在加载，则退出
        if (!ifLoad) return;

        getData(pageNow, url);

    });

    function getData(pageNow, url){
    	$('.infinite-scroll-preloader').show();
    	$(".pullbox").attr("data-ifLoad",0);
    	$.ajax({
        	url: url,
        	type: 'POST',
        	dataType: 'json',
        	data: {
        		page: pageNow
        	},
        	success: function(res){

        		if(res.code>0){

				    var html=bt('tpl_pull',res);
				    $(".pullbox>.list-container").append(html);

			        if($(".page-group").attr("id") == 'page-guessList'){
						ifLoad = res.data.proData.ifLoad,
						pageNow = res.data.proData.pageNow;
					}else{
						ifLoad = res.data.ifLoad,
						pageNow = res.data.pageNow;
					}
			    	$(".pullbox").attr("data-pageNow", pageNow+1);
					$(".pullbox").attr("data-ifLoad", ifLoad);
			        if (!ifLoad) {
			            // 加载完毕，则注销无限加载事件，以防不必要的加载
			            $.detachInfiniteScroll($('.infinite-scroll'));
			            // 删除加载提示符
			            $('.infinite-scroll-preloader').remove();
			        }

        			// if(res["data"]["pageNow"]>1 && res["data"]["data"].length<=0){
        			// 	$.toast("没有更多了...");
        			// }

				    if(!!fn){
				    	fn();
				    }

        		}else{
        			// $.toast(res.msg);
        			// if($("#errorTips").length<=0){
        			// 	$(".pullbox>.list-container").append('<div id="errorTips">'+ res.msg +',<span class="b-refresh">点击刷新</span></div>');
        			// }else{
        			// 	$("#errorTips").html(res.msg +',<span class="b-refresh">点击刷新</span>');
        			// }
        			// 加载完毕，则注销无限加载事件，以防不必要的加载
		            $.detachInfiniteScroll($('.infinite-scroll'));
		            // 删除加载提示符
		            $('.infinite-scroll-preloader').remove();

        		}

		        //容器发生改变,如果是js滚动，需要刷新滚动
		        $.refreshScroller();
		        $('.infinite-scroll-preloader').hide();

        	}
        });
    }
}


/*点击加载函数*/
function fn_click(fn){
	var bt = baidu.template;
	baidu.template.ESCAPE = false;
	var pageNow = 1,
		ifLoad = 1,
		url = $(".clickbox").attr("data-href");
	$(".clickbox").attr("data-pageNow", pageNow);
	getData(pageNow, url);

	// 注册'infinite'事件处理函数
    $(".clickbtn").on('click', function() {
    	pageNow = $(".clickbox").attr("data-pageNow"),
		ifLoad = parseInt($(".clickbox").attr("data-ifLoad")),
		url = $(".clickbox").attr("data-href");

        // 如果正在加载，则退出
        if (!ifLoad) return;

        getData(pageNow, url);

    });

    function getData(pageNow, url){
    	$('.infinite-scroll-preloader').show();
    	$(".clickbox").attr("data-ifLoad", 0);
    	$.ajax({
        	url: url,
        	type: 'POST',
        	dataType: 'json',
        	data: {
        		page: pageNow
        	},
        	success: function(res){

        		if(res.code>0){

        			var html=bt('tpl_click',res);
				    $(".clickbox>.list-container").append(html);
				    $('.infinite-scroll-preloader').hide();

			        ifLoad = res.data.ifLoad,
					pageNow = res.data.pageNow;
			    	$(".clickbox").attr("data-pageNow", pageNow+1);
					$(".clickbox").attr("data-ifLoad", ifLoad);

			        if (!ifLoad) {
			            $('.infinite-scroll-preloader,.clickbtn').remove();
			        }

        			// if(res["data"]["pageNow"]>1 && res["data"]["data"].length<=0){
        			// 	$.toast("没有更多了...");
        			// }

				    if(!!fn){
				    	fn();
				    }

        		}else{

        			if($("#errorTips").length<=0){
        				$(".clickbox>.list-container").append('<div id="errorTips">'+ res.msg +',<span class="b-refresh">点击刷新</span></div>');
        			}else{
        				$("#errorTips").html(res.msg +',<span class="b-refresh">点击刷新</span>');
        			}
        			$('.infinite-scroll-preloader,.clickbtn').remove();

        		}

		        //容器发生改变,如果是js滚动，需要刷新滚动
		        $.refreshScroller();
		        $('.infinite-scroll-preloader').hide();
        	}
        });

    }
}

/*tab点击加载函数*/
function fn_click_tab(index, fn){
	var bt = baidu.template;
	baidu.template.ESCAPE = false;
	var pageNow = 1,
		ifLoad = 1,
		url = $(".guessTab").attr("data-href");
	index = !!index ? index : 0;
	$(".guessTab li").attr("data-pageNow", pageNow);

    $(".guessTab li").on('click', function() {
    	$(".guessTab li").removeClass("active");
    	$(this).addClass("active");
    	$(".clickbox>.list-container").html('');
    	$('.infinite-scroll-preloader').show();
    	var obj = $(".guessTab li.active");
    	pageNow = 1,
		ifLoad = 1,
		url = $(".guessTab").attr("data-href"),
		type = obj.attr("data-type");

        if(!!xhr){
        	xhr.abort();
        }

        getData(type, pageNow, url);
    });
	$(".guessTab li").eq(index).trigger("click");

    $(".clickbtn").on('click', function() {
    	var obj = $(".guessTab li.active");
    	pageNow = obj.attr("data-pageNow"),
		ifLoad = parseInt(obj.attr("data-ifLoad")),
		url = $(".guessTab").attr("data-href"),
		type = obj.attr("data-type");

        // 如果正在加载，则退出
        if (!ifLoad) return;

        // 设置flag
        loading = true;

        getData(type, pageNow, url);
    });

    function getData(type, pageNow, url){
    	$('.infinite-scroll-preloader').show();
    	$(".guessTab li.active").attr("data-ifLoad", 0);
    	xhr = $.ajax({
        	url: url,
        	type: 'POST',
        	dataType: 'json',
        	data: {
        		page: pageNow,
        		type: type
        	},
        	success: function(res){

        		if(res.code>0){
        			var html=bt('tpl_click',res);
				    $(".clickbox>.list-container").append(html);
				    $('.infinite-scroll-preloader').hide();

			        ifLoad = res.data.ifLoad,
					pageNow = res.data.pageNow;
			    	$(".guessTab li.active").attr("data-pageNow", pageNow+1);
					$(".guessTab li.active").attr("data-ifLoad", ifLoad);

			        if (!ifLoad) {
			            $('.infinite-scroll-preloader,.clickbtn').hide();
			        }else{
			        	$('.clickbtn').show();
			        }

        			// if(res["data"]["pageNow"]>1 && res["data"]["data"].length<=0){
        			// 	$.toast("没有更多了...");
        			// }

				    if(!!fn){
				    	fn();
				    }

        		}else{

        			if($("#errorTips").length<=0){
        				$(".clickbox>.list-container").append('<div id="errorTips">'+ res.msg +',<span class="b-refresh">点击刷新</span></div>');
        			}else{
        				$("#errorTips").html(res.msg +',<span class="b-refresh">点击刷新</span>');
        			}
        			$('.infinite-scroll-preloader,.clickbtn').hide();
        		}
		        //容器发生改变,如果是js滚动，需要刷新滚动
		        $.refreshScroller();
		        $('.infinite-scroll-preloader').hide();
        	}
        });


    }
}

/*tab上拉加载函数*/
function fn_pull_tab(page, index, fn){
	var bt = baidu.template;
	baidu.template.ESCAPE = false;
	var pageNow = 1,
		ifLoad = 1,
		url = $(".user-tab").attr("data-href");
	index = !!index ? index : 0;

	$(".user-tab li").attr("data-pageNow", pageNow);

    $(".user-tab li").on('click', function() {
    	var pageId = $(this).parents(".page-group").attr("id");
    	if(pageId=="page-orderList" || pageId=="page-myGroup" || pageId=="page-guess" || pageId=="page-afterSales" || pageId=="page-myLottery"){
    		$(".user-tab li").off("click");
    	}
    	$(".user-tab li").removeClass("active");
    	$(this).addClass("active");
    	$(".clickbox>.list-container").html('');
    	$('.infinite-scroll-preloader').show();
    	var obj = $(".user-tab li.active");
    	pageNow = 1,
		ifLoad = 1,
		url = $(".user-tab").attr("data-href"),
		type = obj.attr("data-type");

        if(!!xhr){
        	xhr.abort();
        }
        getData(type, pageNow, url);
    });
	$(".user-tab li").eq(index).trigger("click");

	// 注册'infinite'事件处理函数
    $(page).on('infinite', function() {
    	var obj = $(".user-tab li.active");
    	pageNow = obj.attr("data-pageNow"),
		ifLoad = parseInt(obj.attr("data-ifLoad")),
		url = $(".user-tab").attr("data-href"),
		type = obj.attr("data-type");

        // 如果正在加载，则退出
        if (!ifLoad) return;

        $.showIndicator();
        getData(type, pageNow, url);

    });

    function getData(type, pageNow, url){
    	$('.infinite-scroll-preloader').show();
    	$(".user-tab li.active").attr("data-ifLoad", 0);
    	xhr = $.ajax({
        	url: url,
        	type: 'POST',
        	dataType: 'json',
        	data: {
        		page: pageNow,
        		type: type
        	},
        	success: function(res){

        		if(res.code>0){

        			var html=bt('tpl_pull_tab',res);
				    $(".clickbox>.list-container").append(html);
				    $('.infinite-scroll-preloader').hide();

			        ifLoad = res.data.ifLoad,
					pageNow = res.data.pageNow;
			    	$(".user-tab li.active").attr("data-pageNow", pageNow+1);
					$(".user-tab li.active").attr("data-ifLoad", ifLoad);

			        if (!ifLoad) {
			            $('.infinite-scroll-preloader,.clickbtn').hide();
			        }

        			// if(res["data"]["pageNow"]>1 && res["data"]["data"].length<=0){
        			// 	$.toast("没有更多了...");
        			// }

				    if(!!fn){
				    	fn();
				    }

        		}else{

        			if($("#errorTips").length<=0){
        				$(".clickbox>.list-container").append('<div id="errorTips">'+ res.msg +',<span class="b-refresh">点击刷新</span></div>');
        			}else{
        				$("#errorTips").html(res.msg +',<span class="b-refresh">点击刷新</span>');
        			}
			        $('.infinite-scroll-preloader,.clickbtn').hide();

        		}
                $.hideIndicator();
		        //容器发生改变,如果是js滚动，需要刷新滚动
		        $.refreshScroller();
		        $('.infinite-scroll-preloader').hide();

        	}
        });

    }
}


/**
 * 上拉加载更多
 * @param [option -> data] 请求的数据
 * @param [option -> ifLoad] 可否继续请求
 * @param [option -> tplId] 模板id
 * @param [option -> callback] 成功回调函数
 */
function pullMore(option){
    option.data = $.extend({
        page: 1
    }, option.data);
    if(!option.ifLoad) ifLoad = true;
    // 加载flag
    var loading = false;

    // 请求返回的数据存储
    var resData = {};

    // 执行请求
    this.getData = function() {

        // 如果正在加载，则退出
        if (loading) return;
		
		$('.infinite-scroll-preloader').show();

        // 设置flag
        loading = true;

        $.ajax({
            url: option.url,
            data: option.data,
            dataType: 'json',
            type: 'post',
            success: function(req){
                resData = req;
                // 重置加载flag
                loading = false,
                option.ifLoad = !req.data.ifLoad;
                // 页码+1
                option.data.page += 1;

                // 添加新条目
                var aHtml = baidu.template(option.tplId, req.data);
                $(option.container).append(aHtml);

                // 执行回调函数
                if(!!option.callback) option.callback();

                if (option.ifLoad) {
                    // 加载完毕，则注销无限加载事件，以防不必要的加载
                    $.detachInfiniteScroll($('.infinite-scroll'));
                    // 删除加载提示符
                    $('.infinite-scroll-preloader').remove();
                    return;
                }

                //容器发生改变,如果是js滚动，需要刷新滚动
                $.refreshScroller();
				$('.infinite-scroll-preloader').hide();

            },
            error: function(){
                $(option.container).html('<div id="errorTips">网络异常<span class="b-refresh">点击刷新</span></div>');
                $('.infinite-scroll-preloader').hide();
            }
        });
    }
    
    //预先加载
    getData();

    // 获取返回的数据
    this.getRes = function(){
        return resData;
    }

    // 获取请求的数据
    this.getReq = function(){
        return option;
    }

    // 设置请求的数据
    this.setReq = function(newData){
        option.data = $.extend(option.data, newData);
    }

    // 注册'infinite'事件处理函数
    $(option.pageId).on('infinite', function() {
        getData();
    });

    return this;
}
